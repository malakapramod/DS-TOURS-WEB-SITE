<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - DS Tours</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-green': '#00897b',
                        'brand-dark': '#004d40',
                        'brand-gold': '#ffb300',
                    },
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-gray-100 font-sans">

    <!-- Login Overlay -->
    <div id="loginOverlay" class="fixed inset-0 bg-brand-dark flex flex-col justify-center items-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full mx-6">
            <h2 class="text-2xl font-bold text-center text-brand-dark mb-6">Admin Login</h2>
            <input type="email" id="emailInput" placeholder="Email" class="w-full px-4 py-3 border rounded-lg mb-2">
            <input type="password" id="passwordInput" placeholder="Password"
                class="w-full px-4 py-3 border rounded-lg mb-4">
            <button id="loginBtn"
                class="w-full bg-brand-green text-white font-bold py-3 rounded-lg hover:bg-brand-dark transition-colors">Login</button>
            <p id="errorMsg" class="text-red-500 text-sm mt-3 text-center hidden">Invalid Credentials</p>

            <div class="mt-6 pt-4 border-t border-gray-100 text-center">
                <a href="index.html"
                    class="text-sm text-gray-500 hover:text-brand-green font-medium transition-colors">‚Üê Back to
                    Home</a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="adminContent" class="hidden min-h-screen flex flex-col">
        <header class="bg-white shadow border-b border-gray-200 sticky top-0 z-40">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <span class="text-brand-gold text-3xl">‚úà</span>
                    <h1 class="text-2xl font-bold text-brand-dark">Admin Dashboard</h1>
                </div>
                <div class="flex items-center gap-4">
                    <nav class="flex space-x-4">
                        <button onclick="switchTab('ratings')" id="tab-ratings"
                            class="px-3 py-2 rounded-md bg-brand-green text-white font-medium">Ratings</button>
                        <button onclick="switchTab('destinations')" id="tab-destinations"
                            class="px-3 py-2 rounded-md text-gray-600 hover:bg-gray-100 font-medium">Destinations</button>
                    </nav>
                    <button id="logoutBtn"
                        class="text-red-500 hover:text-red-700 text-sm border border-red-200 px-4 py-2 rounded-lg">Logout</button>
                </div>
            </div>
        </header>

        <main class="flex-grow container mx-auto px-6 py-8">

            <!-- Ratings View -->
            <div id="view-ratings">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <p class="text-gray-500 text-sm font-medium uppercase">Total Reviews</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-1" id="totalReviews">0</h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <p class="text-gray-500 text-sm font-medium uppercase">Average Rating</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-1" id="avgRating">0.0</h3>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                    <div class="px-8 py-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                        <h2 class="text-xl font-bold text-gray-800">Recent Feedback</h2>
                        <button onclick="loadRatings()" class="text-brand-green text-sm font-medium">üîÑ Refresh</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
                                <tr>
                                    <th class="px-8 py-4">Date</th>
                                    <th class="px-8 py-4">Client</th>
                                    <th class="px-8 py-4">Rating</th>
                                    <th class="px-8 py-4 w-1/3">Comment</th>
                                    <th class="px-8 py-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reviewsTableBody" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Destinations View -->
            <div id="view-destinations" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Manage Destinations</h2>
                    <button onclick="openDestModal()"
                        class="bg-brand-gold text-brand-dark font-bold px-6 py-2 rounded-lg hover:bg-yellow-400 shadow transition-colors">+
                        Add New</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="destGrid">
                    <!-- Destinations Loaded Here -->
                </div>
            </div>

        </main>
    </div>

    <!-- Destination Modal -->
    <div id="destModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-8 relative">
            <button onclick="closeDestModal()"
                class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">‚úï</button>
            <h3 class="text-2xl font-bold mb-6 text-brand-dark" id="modalTitle">Add Destination</h3>

            <form id="destForm" class="space-y-4">
                <input type="hidden" id="destId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" id="destTitle" required
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-brand-green outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Image URL</label>
                    <input type="url" id="destImage" required
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-brand-green outline-none"
                        placeholder="https://example.com/image.jpg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="destDesc" required rows="4"
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-brand-green outline-none"></textarea>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeDestModal()"
                        class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
                    <button type="submit"
                        class="px-6 py-2 bg-brand-green text-white font-bold rounded-lg hover:bg-brand-dark">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/storage.js"></script>
    <script>
        // --- AUTH ---
        const loginOverlay = document.getElementById('loginOverlay');
        const adminContent = document.getElementById('adminContent');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');

        if (sessionStorage.getItem('adminLoggedIn') === 'true') {
            showAdmin();
        }

        document.getElementById('loginBtn').addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;

            // Try backend login
            try {
                const res = await fetch('backend/login.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();

                if (res.ok && data.success && data.role === 'admin') {
                    sessionStorage.setItem('adminLoggedIn', 'true');
                    showAdmin();
                } else {
                    throw new Error(data.error || 'Login failed');
                }
            } catch (e) {
                console.error(e);
                // Fallback for demo without backend
                if (email === 'admin@dstours.lk' && password === 'admin123') {
                    sessionStorage.setItem('adminLoggedIn', 'true');
                    showAdmin();
                } else {
                    document.getElementById('errorMsg').classList.remove('hidden');
                }
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            sessionStorage.removeItem('adminLoggedIn');
            location.reload();
        });

        function showAdmin() {
            loginOverlay.classList.add('hidden');
            adminContent.classList.remove('hidden');
            loadRatings();
            loadDestinations();
        }

        // --- TABS ---
        function switchTab(tab) {
            document.getElementById('view-ratings').classList.add('hidden');
            document.getElementById('view-destinations').classList.add('hidden');
            document.getElementById('tab-ratings').classList.remove('bg-brand-green', 'text-white');
            document.getElementById('tab-destinations').classList.remove('bg-brand-green', 'text-white');

            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('bg-brand-green', 'text-white');
        }

        // --- RATINGS ---
        async function loadRatings() {
            const tbody = document.getElementById('reviewsTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8">Loading...</td></tr>';

            try {
                const ratings = await window.StorageService.getRatings(); // Uses storage.js abstraction
                const avg = await window.StorageService.getAverageRating();

                document.getElementById('totalReviews').innerText = ratings.length;
                document.getElementById('avgRating').innerText = avg;

                tbody.innerHTML = '';
                if (ratings.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">No reviews found.</td></tr>';
                    return;
                }

                ratings.forEach(r => {
                    const stars = '‚òÖ'.repeat(parseInt(r.rating)) + '<span class="text-gray-300">' + '‚òÖ'.repeat(5 - parseInt(r.rating)) + '</span>';
                    const row = `
                        <tr class="hover:bg-gray-50 border-b border-gray-100 last:border-0">
                            <td class="px-8 py-4 text-sm text-gray-600">${new Date(r.timestamp || r.created_at || Date.now()).toLocaleDateString()}</td>
                            <td class="px-8 py-4 font-medium">${r.name}</td>
                            <td class="px-8 py-4 text-brand-gold text-lg">${stars}</td>
                            <td class="px-8 py-4 text-sm italic text-gray-600">${r.comment}</td>
                            <td class="px-8 py-4 text-right">
                                <button onclick="window.StorageService.deleteRating('${r.id}').then(loadRatings)" class="text-red-500 hover:text-red-700 p-2">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-red-500">Error loading data. Ensure backend is running.</td></tr>';
            }
        }

        // --- HELPER: API Wrapper with Fallback ---
        async function apiCall(url, method = 'GET', body = null) {
            try {
                // Try fetching from backend
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' }
                };
                if (body) options.body = JSON.stringify(body);

                const res = await fetch(url, options);
                const contentType = res.headers.get("content-type");

                // If response is not JSON (e.g., PHP source code returned), throw error
                if (!contentType || !contentType.includes("application/json")) {
                    throw new Error("Backend not running (Invalid Content-Type)");
                }

                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Server Error');
                return data;

            } catch (err) {
                console.warn(`Backend unreachable (${url}), using localStorage fallback. Error:`, err);

                // FALLBACK LOGIC
                if (url.includes('destinations.php')) {
                    const localData = JSON.parse(localStorage.getItem('destinations') || '[]');

                    if (method === 'GET') return localData;

                    if (method === 'POST') {
                        const newItem = { ...body, id: Date.now(), created_at: new Date().toISOString() };
                        localData.push(newItem);
                        localStorage.setItem('destinations', JSON.stringify(localData));
                        return { success: true, id: newItem.id };
                    }

                    if (method === 'PUT') {
                        const index = localData.findIndex(d => d.id == body.id);
                        if (index !== -1) {
                            localData[index] = { ...localData[index], ...body };
                            localStorage.setItem('destinations', JSON.stringify(localData));
                            return { success: true };
                        }
                        throw new Error("Item not found");
                    }

                    if (method === 'DELETE') {
                        const newData = localData.filter(d => d.id != body.id);
                        localStorage.setItem('destinations', JSON.stringify(newData));
                        return { success: true };
                    }
                }
                throw err; // Re-throw if no fallback available
            }
        }

        // --- DESTINATIONS ---
        async function loadDestinations() {
            const grid = document.getElementById('destGrid');
            grid.innerHTML = '<p class="col-span-3 text-center">Loading...</p>';

            try {
                // Modified to use apiCall wrapper or direct fetch handling
                // For simplicity, we rewrite logic here to use our new apiCall wrapper style
                // purely via apiCall wrapper
                const data = await apiCall('backend/destinations.php');

                grid.innerHTML = '';
                if (!Array.isArray(data)) throw new Error("Invalid format");

                if (data.length === 0) {
                    grid.innerHTML = '<p class="col-span-3 text-center text-gray-500 py-10">No destinations found. Add one!</p>';
                    return;
                }

                data.forEach(d => {
                    const card = `
                        <div class="bg-white rounded-xl shadow overflow-hidden group">
                            <div class="h-48 overflow-hidden relative">
                                <img src="${d.image_url}" alt="${d.title}" class="w-full h-full object-cover group-hover:scale-105 transition-transform" onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">
                                <div class="absolute top-2 right-2 flex gap-2">
                                    <button onclick="editDest(${d.id}, '${d.title.replace(/'/g, "\\'")}', '${d.image_url}', '${d.description.replace(/'/g, "\\'")}')" class="bg-white p-2 rounded-full shadow hover:bg-gray-100">‚úèÔ∏è</button>
                                    <button onclick="deleteDest(${d.id})" class="bg-red-500 text-white p-2 rounded-full shadow hover:bg-red-600">üóëÔ∏è</button>
                                </div>
                            </div>
                            <div class="p-4">
                                <h3 class="font-bold text-lg mb-2">${d.title}</h3>
                                <p class="text-sm text-gray-600 line-clamp-3">${d.description}</p>
                            </div>
                        </div>
                    `;
                    grid.insertAdjacentHTML('beforeend', card);
                });
            } catch (err) {
                grid.innerHTML = `
                    <div class="col-span-3 text-center py-10 bg-white rounded-xl">
                        <p class="text-gray-500 mb-4">No backend or fallback unavailable.</p>
                        <p class="text-xs text-red-500">${err.message}</p>
                    </div>
                `;
            }
        }

        const destModal = document.getElementById('destModal');
        const destForm = document.getElementById('destForm');

        function openDestModal() {
            document.getElementById('modalTitle').innerText = 'Add Destination';
            document.getElementById('destId').value = '';
            destForm.reset();
            destModal.classList.remove('hidden');
        }

        function closeDestModal() {
            destModal.classList.add('hidden');
        }

        window.editDest = function (id, title, img, desc) {
            document.getElementById('modalTitle').innerText = 'Edit Destination';
            document.getElementById('destId').value = id;
            document.getElementById('destTitle').value = title;
            document.getElementById('destImage').value = img;
            document.getElementById('destDesc').value = desc;
            destModal.classList.remove('hidden');
        }

        window.deleteDest = async function (id) {
            if (!confirm("Delete this destination?")) return;
            try {
                await apiCall('backend/destinations.php', 'DELETE', { id });
                loadDestinations();
            } catch (e) { alert(e.message); }
        }

        destForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('destId').value;
            const title = document.getElementById('destTitle').value;
            const image_url = document.getElementById('destImage').value;
            const description = document.getElementById('destDesc').value;

            const method = id ? 'PUT' : 'POST';
            const body = { title, image_url, description };
            if (id) body.id = id;

            try {
                await apiCall('backend/destinations.php', method, body);
                closeDestModal();
                loadDestinations();
            } catch (err) {
                alert("Error saving destination: " + err.message);
                console.error(err);
            }
        });
    </script>
</body>

</html>